name: Deploy Gist Getter API
run-name: ${{ github.actor }} is deploying Gist Getter API
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy-to-minikube:
    runs-on: self-hosted
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Build Docker image
        run: docker build -t ee:latest .

      - name: Load image into minikube
        run: minikube image load ee:latest

      - name: Clean up old deployments
        run: |
          kubectl delete deployment gist-getter --ignore-not-found=true
          kubectl delete service gist-getter-service --ignore-not-found=true
          sleep 10

      - name: Deploy to Kubernetes
        run: kubectl apply -f deployment.yml

      - name: Wait for deployment to be ready
        run: kubectl rollout status deployment/gist-getter --timeout=300s

      - name: Verify deployment
        run: kubectl get pods -l app=gist-getter
